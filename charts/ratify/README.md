# Ratify Helm Chart

## Get Repo Info

```console
helm repo add ratify https://deislabs.github.io/ratify
helm repo update
```

_See [helm repo](https://helm.sh/docs/helm/helm_repo/) for command documentation._

## Install Chart

```console
# Helm install with gatekeeper-system namespace already created
$ helm install [RELEASE_NAME] ratify/ratify --atomic --namespace gatekeeper-system --set featureFlags.RATIFY_CERT_ROTATION=true

# Helm install and create namespace
$ helm install [RELEASE_NAME] ratify/ratify --atomic --namespace gatekeeper-system --create-namespace --set featureFlags.RATIFY_CERT_ROTATION=true

```

_See [parameters](#parameters) below._

_See [helm install](https://helm.sh/docs/helm/helm_install/) for command documentation._

## Upgrade Chart

```console
$ helm upgrade -n gatekeeper-system [RELEASE_NAME] ratify/ratify
```

## Parameters

| Parameter                                          | Description                                                                                                                                                                                                                         | Default                        |
| -------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------ |
| image.repository                                   | Ratify app image                                                                                                                                                                                                                    | `ghcr.io/deislabs/ratify`      |
| image.crdrepository                                | Ratify CRD install Image                                                                                                                                                                                                            | `ghcr.io/deislabs/ratify-crds` |
| image.tag                                          | Image tag                                                                                                                                                                                                                           | `<INSERT THE LATEST RELEASE TAG>`                       |
| image.pullPolicy                                   | Image pull policy                                                                                                                                                                                                                   | `IfNotPresent`                 |
| nameOverride                                       | Overrides the ratify.name used to determine the ratify full name template                                                                                                                                                           | ``                             |
| fullnameOverride                                   | Overrides the ratify applicaiton full name template                                                                                                                                                                                 | ``                             |
| replicaCount                                       | The number of Ratify replicas in deployment                                                                                                                                                                                         | 1                              |
| affinity                                           | Pod affinity for the Ratify deployment                                                                                                                                                                                              | `{}`                           |
| tolerations                                        | Pod tolerations for the Ratify deployment                                                                                                                                                                                           | `[]`                           |
| notationCert                                       | Public certificate/certificate chain used to create inline certstore used by Notation verifier. This value has been ***deprecated*** , and will be removed in future releases of Ratify. Please switch to ```notationCerts``` to specify an array of verification certificates                                                                                                                                  | ``                             |
| notationCerts                                      | An array of public certificate/certificate chain used to create inline certstore used by Notation verifier                                                                  | ``                             |
| cosign.enabled                                     | Enables/disables cosign tag-based signature lookup in ORAS store. MUST be set to true for cosign verification.                                                                                                                      | `true`                         |
| cosign.key                                         | Public certificate used by cosign verifier                                                                                                                                                                                          | ``                             |
| resources.limits.cpu                               | CPU limits of Ratify Deployment                                                                                                                                                                                                     | `1000m`                        |
| resources.limits.memory                            | Memory limits of Ratify Deployment                                                                                                                                                                                                  | `512Mi`                        |
| resources.requests.cpu                             | CPU request of Ratify Deployment                                                                                                                                                                                                    | `600m`                         |
| resources.requests.memory                          | Memory request of Ratify Deployment                                                                                                                                                                                                 | `512Mi`                        |
| serviceAccount.create                              | Create new dedicated Ratify service account                                                                                                                                                                                         | `true`                         |
| serviceAccount.name                                | Name of Ratify service account to create                                                                                                                                                                                            | `ratify-admin`                 |
| gatekeeper.version                                 | Determines the Gatekeeper CRD versioning                                                                                                                                                                                            | `3.14.0`                       |
| gatekeeper.namespace                               | Namespace Gatekeeper is installed                                                                                                                                                                                                   | `gatekeeper-system`            |
| instrumentation.metricsEnabled                     | Initializes the configured metrics provider                                                                                                                                                                                         | `true`                         |
| instrumentation.metricsType                        | Specifies the metrics provider type                                                                                                                                                                                                 | `prometheus`                   |
| instrumentation.metricsPort                        | The metrics server port on Ratify container                                                                                                                                                                                         | `8888`                         |
| oras.useHttp                                       | Disables TLS verification and uses `http` for registry communication (Note: use for development purposes ONLY)                                                                                                                      | `false`                        |
| oras.authProviders.azureWorkloadIdentityEnabled    | Enables Azure Workload Identity authentication provider                                                                                                                                                                             | `false`                        |
| oras.authProviders.azureManagedIdentityEnabled     | Enables Azure Managed Identity authentication provider                                                                                                                                                                              | `false`                        |
| oras.authProviders.k8secretsEnabled                | Enables kubernetes secrets authentication provider for registry interactions                                                                                                                                                        | `false`                        |
| oras.authProviders.awsEcrBasicEnabled              | Enables AWS ECR basic authentication provider                                                                                                                                                                                       | `false`                        |
| oras.authProviders.awsApiOverride.enabled          | Enables API URL overrides                                                                                                                                                                                                           | `false`                        |
| oras.authProviders.awsApiOverride.endpoint         | Overrides ECR endpoint                                                                                                                                                                                                              | ``                             |
| oras.authProviders.awsApiOverride.partition        | Overrides ECR partition in the endpoint URL                                                                                                                                                                                         | `aws`                          |
| oras.authProviders.awsApiOverride.region           | Overrides ECR region in the endpoint URL                                                                                                                                                                                            | ``                             |
| oras.cache.enabled                                 | Enables ORAS store cache for ListReferrers and GetSubjectDescriptor. TTL-based cache may cause inconsistency between cache and data source. Please disable it if strong consistency is required.operations                          | `true`                         |
| oras.cache.ttl                                     | Sets the ttl for ORAS store in seconds. cache                                                                                                                                                                                       | `10`                           |
| provider.tls.crt                                   | Ratify server's tls public certificate                                                                                                                                                                                              | ``                             |
| provider.tls.key                                   | Ratify server's tls private key                                                                                                                                                                                                     | ``                             |
| provider.tls.caCert                                | Ratify server's CA public certificate. TLS certificate is generated using CA.                                                                                                                                                       | ``                             |
| provider.tls.caKey                                 | Ratify server's CA private key.                                                                                                                                                                                                     | ``                             |
| provider.tls.cabundle                              | Base64 encoded CA bundle used for the 'caBundle' property of the Provider CR of Gatekeeper. CRD                                                                                                                                     | ``                             |
| provider.timeout.validationTimeoutSeconds          | Verify request handler timeout in seconds. This MUST match the configured Gatekeeper `validatingWebhookTimeoutSeconds`.                                                                                                             | `5`                            |
| provider.timeout.mutationTimeoutSeconds            | Mutate request handler timeout in seconds. This MUST match the configured Gatekeeper `mutatingWebhookTimeoutSeconds`                                                                                                                | `2`                            |
| provider.cache.enabled                             | Enables/disables non-ORAS store caches such as request cache and authentication cache.                                                                                                                                              | `true`                         |
| provider.cache.type                                | The cache provider for global cache. (use `dapr` for HA scenarios)                                                                                                                                                                  | `ristretto`                    |
| provider.cacheSizeMb                               | Local cache max size allocated (applicable only if `ristretto` cache type selected)                                                                                                                                                 | `256`                          |
| provider.ttl                                       | TTL in seconds of global cache                                                                                                                                                                                                      | `10s`                          |
| provider.name                                      | The state store provider name used with dapr (applicable only if `dapr` cache type selected)                                                                                                                                        | `dapr-redis`                   |
| provider.enableMutation                            | Enables/disables tag-to-digest mutation for all admission resource creations. It is highly recommended to enable mutation since the verified digest may be different from the one run.                                              | `true`                         |
| podAnnotations                                     | Adds specified annotations to Ratify deployment                                                                                                                                                                                     | `{}`                           |
| podLabels                                          | Adds specified labels to Ratify deployment                                                                                                                                                                                          | `{}`                           |
| enableRuntimeDefaultSeccompProfile                 | Sets the container's `seccomp` profile to be RuntimeDefault                                                                                                                                                                         | `true`                         |
| healthPort                                         | Liveness & readiness probe's port for ratify container                                                                                                                                                                              | `9099`                         |
| rbac.create                                        | Enable/disable RBAC roles for ratify manager                                                                                                                                                                                        | `true`                         |
| upgradeCRDs.enabled                                | Enable/disable Ratify CRD upgrades as pre-install chart hooks                                                                                                                                                                       | `true`                         |
| upgradeCRDs.extraRules                             | List of rules to add to Ratify CRD upgrade ClusterRole                                                                                                                                                                              | `[]`                           |
| crds.affinity                                      | Pod affinity for the upgrade CRD Job                                                                                                                                                                                                | `{}`                           |
| crds.tolerations                                   | Pod tolerations for the upgrade CRD Job                                                                                                                                                                                             | `[]`                           |
| crds.nodeSelector                                  |                                                                                                                                                                                                                                     | `{kubernetes.io/os: linux}`    |
| crds.resources                                     | Resource limits/requests for ratify upgrade CRD job                                                                                                                                                                                 | ``                             |
| crds.securityContext.allowPrivilegeEscalation      | Enables/disables privilege elevation for crd upgrade container                                                                                                                                                                      | `false`                        |
| crds.securityContext.capabilities.drop             | List of allowed capabilities for crd upgrade container                                                                                                                                                                              | `['ALL']`                      |
| crds.securityContext.readOnlyRootFilesystem        | Enable/disable read-only filesystem for crd upgrade container                                                                                                                                                                       | `true`                         |
| crds.securityContext.runAsGroup                    | Sets user group context                                                                                                                                                                                                             | `65532`                        |
| crds.securityContext.runAsNonRoot                  | Enable/disable root user role                                                                                                                                                                                                       | `true`                         |
| crds.securityContext.runAsUser                     | Sets user context                                                                                                                                                                                                                   | `65532`                        |
| policy.useRego                                     | Enables/disable OPA rego policy CRD                                                                                                                                                                                                 | `false`                        |
| logger.formatter                                   | Type of log formatter. Can be set to `text`, `json` or `logstash` output                                                                                                                                                            | `text`                         |
| logger.level                                       | Sets the log level                                                                                                                                                                                                                  | `info`                         |
| logger.requestHeaders.traceIDHeaderName            | List of headers that include the trace ID in the external data requests to Ratify. The same headers will be passed to upstream services like remote registries. e.g. Set it to `x-ms-correlation-request-id` to trace across Azure. | `[]`                           |
| featureFlags.RATIFY_CERT_ROTATION                  | Enables/disables tls certificate rotation                                                                                                                                                                                           | `false`                        |
| featureFlags.RATIFY_EXPERIMENTAL_HIGH_AVAILABILITY | **EXPERIMENTAL** Enables/disables high availability mode including distributed caching.                                                                                                                                             | `false`                        |
| azureWorkloadIdentity.clientId                     | ClientID of AAD application/Managed identity associated with Workload Identity                                                                                                                                                      | ``                             |
| azureManagedIdentity.clientId                      | ClientID of Managed identity                                                                                                                                                                                                        | ``                             |
| azureManagedIdentity.tenantId                      | TenantID of Managed Identity resource                                                                                                                                                                                               | ``                             |
| akvCertConfig.enabled                              | Enables/disables Azure Key Vault certificate store. If you are using a custom chart, certificate store should be referenced through a Verifier CR. References in ConfigMap will not be correctly resolved.                                                                                                                                                                   | `false`                        |
| akvCertConfig.vaultURI                             | Vault URI for AKV configured                                                                                                                                                                                                        | ``                             |
| akvCertConfig.cert1Name                            | Exact name of the certificate stored in AKV. This value has been ***deprecated*** , and will be removed in future releases of Ratify. Please switch to ```akvCertConfig.certificates``` to specify an array of  certificates                                                                                                                                                                                      | ``                             |
| akvCertConfig.cert1Version                         | Exact version of certificate to use from AKV. This value has been ***deprecated*** , and will be removed in future releases of Ratify. Please switch to ```akvCertConfig.certificates``` to specify an array of verification certificates                                                                                                                                                                                    | ``                             |
| akvCertConfig.cert2Name                            | Exact name of the certificate stored in AKV. This value has been ***deprecated*** , and will be removed in future releases of Ratify. Please switch to ```akvCertConfig.certificates``` to specify an array of verification certificates                                                                                                                                                                                         | ``                             |
| akvCertConfig.cert2Version                         | Exact version of certificate to use from AKV. This value has been ***deprecated*** , and will be removed in future releases of Ratify. Please switch to ```akvCertConfig.certificates``` to specify an array of verification certificates                                                                                                                                                                                      | ``                             |
| akvCertConfig.certificates                            | An array of certificate objects identified by certificateName and certificateVersion stored in AKV                                                                                                                                                                                          | ``                             
| akvCertConfig.tenantId                             | TenantID of the configured AKV resource                                                                                                                                                                                             | ``                             |
